<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 확인 및 복구</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9fafb;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        .data-item {
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .key {
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }
        .value {
            font-size: 0.9rem;
            color: #666;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        .empty {
            color: #ef4444;
            font-weight: 600;
        }
        .btn {
            padding: 0.5rem 1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <h1>LocalStorage 데이터 확인 및 복구</h1>
    
    <div class="section">
        <h2>견적서 데이터 (growth_launchpad_quotes)</h2>
        <div id="quotes-data"></div>
        <div id="quotes-issues" style="margin-top: 1rem;"></div>
        <button class="btn" onclick="exportData('quotes')">데이터 내보내기 (JSON)</button>
        <button class="btn" onclick="importData('quotes')">데이터 가져오기 (JSON)</button>
        <button class="btn" onclick="fixMissingQuoteDates()">견적일자 없는 견적서 수정</button>
    </div>
    
    <div class="section">
        <h2>고객사 데이터 (growth_launchpad_customers)</h2>
        <div id="customers-data"></div>
        <button class="btn" onclick="exportData('customers')">데이터 내보내기 (JSON)</button>
        <button class="btn" onclick="importData('customers')">데이터 가져오기 (JSON)</button>
    </div>
    
    <div class="section">
        <h2>상품 데이터 (growth_launchpad_products)</h2>
        <div id="products-data"></div>
        <button class="btn" onclick="exportData('products')">데이터 내보내기 (JSON)</button>
        <button class="btn" onclick="importData('products')">데이터 가져오기 (JSON)</button>
    </div>
    
    <div class="section">
        <h2>자료실 데이터 (growth_launchpad_resources)</h2>
        <div id="resources-data"></div>
        <button class="btn" onclick="exportData('resources')">데이터 내보내기 (JSON)</button>
        <button class="btn" onclick="importData('resources')">데이터 가져오기 (JSON)</button>
    </div>
    
    <div class="section">
        <h2>모든 LocalStorage 키</h2>
        <div id="all-keys"></div>
        <button class="btn btn-danger" onclick="clearAllData()">⚠️ 모든 데이터 삭제 (주의!)</button>
    </div>

    <script src="assets/js/main.js"></script>
    <script>
        // 로그인 체크
        if (!window.checkLogin || !window.checkLogin()) {
            // 리다이렉트는 checkLogin 함수에서 처리됨
        }

        const STORAGE_KEYS = {
            quotes: 'growth_launchpad_quotes',
            customers: 'growth_launchpad_customers',
            products: 'growth_launchpad_products',
            resources: 'growth_launchpad_resources'
        };

        function loadData() {
            // 각 데이터 타입별로 로드
            Object.keys(STORAGE_KEYS).forEach(type => {
                const key = STORAGE_KEYS[type];
                const data = localStorage.getItem(key);
                const container = document.getElementById(`${type}-data`);
                
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const count = Array.isArray(parsed) ? parsed.length : Object.keys(parsed).length;
                        container.innerHTML = `
                            <div class="data-item">
                                <div class="key">${key}</div>
                                <div class="value">데이터 개수: ${count}개</div>
                                <details>
                                    <summary>데이터 보기</summary>
                                    <pre>${JSON.stringify(parsed, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                        
                        // 견적서 데이터인 경우 문제점 확인
                        if (type === 'quotes' && Array.isArray(parsed)) {
                            checkQuoteIssues(parsed);
                        }
                    } catch (e) {
                        container.innerHTML = `<div class="data-item"><div class="key">${key}</div><div class="value">파싱 오류: ${e.message}</div></div>`;
                    }
                } else {
                    container.innerHTML = `<div class="data-item"><div class="key">${key}</div><div class="value empty">데이터 없음</div></div>`;
                }
            });

            // 모든 키 표시
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allKeys.push(key);
            }
            document.getElementById('all-keys').innerHTML = `
                <div class="data-item">
                    <div class="key">총 ${allKeys.length}개의 키</div>
                    <div class="value">${allKeys.join(', ')}</div>
                </div>
            `;
        }

        function exportData(type) {
            const key = STORAGE_KEYS[type];
            const data = localStorage.getItem(key);
            if (!data) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        JSON.parse(data); // 유효성 검사
                        const key = STORAGE_KEYS[type];
                        localStorage.setItem(key, data);
                        alert('데이터가 성공적으로 가져와졌습니다.');
                        loadData();
                    } catch (err) {
                        alert('유효하지 않은 JSON 파일입니다: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (!confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다!')) {
                return;
            }
            if (!confirm('정말 확실합니까? 모든 견적서, 고객사, 상품, 자료실 데이터가 삭제됩니다!')) {
                return;
            }
            localStorage.clear();
            alert('모든 데이터가 삭제되었습니다.');
            loadData();
        }

        // 견적서 문제점 확인
        function checkQuoteIssues(quotes) {
            const issuesContainer = document.getElementById('quotes-issues');
            const issues = [];
            
            quotes.forEach((quote, index) => {
                const problems = [];
                
                // quoteDate가 없는 경우
                if (!quote.quoteDate || quote.quoteDate.trim() === '') {
                    problems.push('견적일자(quoteDate) 없음');
                }
                
                // statusHistory['접수']가 없는 경우
                if (!quote.statusHistory || !quote.statusHistory['접수']) {
                    problems.push('접수일자(statusHistory.접수) 없음');
                }
                
                // createdAt이 없는 경우
                if (!quote.createdAt) {
                    problems.push('등록일자(createdAt) 없음');
                }
                
                if (problems.length > 0) {
                    issues.push({
                        index: index,
                        id: quote.id || 'ID 없음',
                        title: quote.quoteTitle || '제목 없음',
                        problems: problems
                    });
                }
            });
            
            if (issues.length > 0) {
                let html = '<div class="data-item" style="background: #fef2f2; border-color: #fecaca;">';
                html += `<div class="key" style="color: #dc2626;">⚠️ 문제가 있는 견적서: ${issues.length}개</div>`;
                html += '<div class="value">';
                issues.forEach(issue => {
                    html += `<div style="margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 4px;">`;
                    html += `<strong>ID: ${issue.id}</strong> - ${issue.title}<br>`;
                    html += `<span style="color: #dc2626;">문제: ${issue.problems.join(', ')}</span>`;
                    html += `</div>`;
                });
                html += '</div></div>';
                issuesContainer.innerHTML = html;
            } else {
                issuesContainer.innerHTML = '<div class="data-item" style="background: #f0fdf4; border-color: #bbf7d0;"><div class="key" style="color: #16a34a;">✓ 모든 견적서가 정상입니다</div></div>';
            }
        }
        
        // 견적일자가 없는 견적서 수정
        function fixMissingQuoteDates() {
            const data = localStorage.getItem(STORAGE_KEYS.quotes);
            if (!data) {
                alert('견적서 데이터가 없습니다.');
                return;
            }
            
            try {
                const quotes = JSON.parse(data);
                let fixedCount = 0;
                
                quotes.forEach(quote => {
                    // quoteDate가 없으면 createdAt의 날짜 부분을 사용
                    if (!quote.quoteDate || quote.quoteDate.trim() === '') {
                        if (quote.createdAt) {
                            const createdDate = new Date(quote.createdAt);
                            quote.quoteDate = createdDate.toISOString().split('T')[0];
                            fixedCount++;
                        }
                    }
                    
                    // statusHistory['접수']가 없으면 quoteDate를 사용
                    if (!quote.statusHistory) {
                        quote.statusHistory = {};
                    }
                    if (!quote.statusHistory['접수']) {
                        if (quote.quoteDate) {
                            quote.statusHistory['접수'] = new Date(quote.quoteDate + 'T00:00:00').toISOString();
                            fixedCount++;
                        } else if (quote.createdAt) {
                            quote.statusHistory['접수'] = quote.createdAt;
                            fixedCount++;
                        }
                    }
                });
                
                if (fixedCount > 0) {
                    localStorage.setItem(STORAGE_KEYS.quotes, JSON.stringify(quotes));
                    alert(`${fixedCount}개의 견적서가 수정되었습니다.`);
                    loadData();
                } else {
                    alert('수정할 견적서가 없습니다.');
                }
            } catch (e) {
                alert('데이터 수정 중 오류가 발생했습니다: ' + e.message);
            }
        }

        // 페이지 로드 시 데이터 표시
        loadData();
    </script>
</body>
</html>

